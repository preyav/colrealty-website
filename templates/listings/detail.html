{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ listing.title }} | Col Realty{% endblock %}

{% block content %}
<a href="/listings/" class="nav-link" style="display:inline-block;margin-bottom:0.75rem;">
  ← Back to listings
</a>

<div class="detail-layout">
  <div class="detail-gallery">
    {% if listing.main_image_url %}
      <img
        src="{{ listing.main_image_url }}"
        alt="{{ listing.title }}"
        class="detail-main-image"
      >
    {% else %}
      <div class="detail-main-image" style="background: radial-gradient(circle at center, #31334b, #11111a);"></div>
    {% endif %}

    <div class="detail-content">
      <div class="detail-header">
        <div class="detail-price">
          ${{ listing.price|floatformat:0|intcomma }}
        </div>
        <div class="detail-location">
          {{ listing.street_address }},
          {{ listing.city }}, {{ listing.state }} {{ listing.zip_code }}
        </div>
        <div class="detail-badges">
          {% if listing.status %}
            <span class="badge">
              Status: {{ listing.status|capfirst }}
            </span>
          {% endif %}
          {% if listing.property_type %}
            <span class="badge">
              {{ listing.property_type }}
            </span>
          {% endif %}
          {% if listing.year_built %}
            <span class="badge">
              Built {{ listing.year_built }}
            </span>
          {% endif %}
        </div>
      </div>

      {% if listing.description %}
        <h2 class="detail-section-title">Property details</h2>
        <p class="detail-description">
          {{ listing.description|linebreaksbr }}
        </p>
      {% endif %}
    </div>
  </div>

  <aside class="detail-sidebar">
    <div class="info-card">
      <div class="info-grid">
        <div>
          <div class="info-label">Beds</div>
          <div class="info-value">
            {{ listing.beds|default:"—" }}
          </div>
        </div>
        <div>
          <div class="info-label">Baths</div>
          <div class="info-value">
            {{ listing.baths|default:"—" }}
          </div>
        </div>
        <div>
          <div class="info-label">Living area</div>
          <div class="info-value">
            {% if listing.sqft %}
              {{ listing.sqft|intcomma }} sqft
            {% else %}
              —
            {% endif %}
          </div>
        </div>
        <div>
          <div class="info-label">Lot size</div>
          <div class="info-value">
            {% if listing.lot_size %}
              {{ listing.lot_size }} acres
            {% else %}
              —
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="info-card cta-card">
      <h2 class="cta-title">Schedule a private showing</h2>
      <p class="cta-text">
        Ready to walk through this home? Share a few details and our team will reach out
        with available times today.
      </p>
      <a href="/contact/" class="btn-primary btn-block">
        Contact Col Realty
      </a>
    </div>

    <div class="info-card map-card">
      <div class="detail-section-title" style="padding:0.75rem 0.75rem 0 0.75rem;">
        Neighborhood
      </div>
      <div id="property-map" class="map-container"></div>
    </div>
  </aside>
</div>
{% endblock %}

{% block extra_js %}
  {% if listing.latitude and listing.longitude %}
    <!-- Leaflet CSS & JS (if not already in base.html) -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tDHDMEkXaFf9Z8HgnbTs="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      (function() {
        var lat = {{ listing.latitude }};
        var lng = {{ listing.longitude }};
        var map = L.map('property-map').setView([lat, lng], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap',
          maxZoom: 19
        }).addTo(map);

        L.marker([lat, lng]).addTo(map)
          .bindPopup("{{ listing.street_address|escapejs }}")
          .openPopup();
      })();
    </script>
  {% endif %}
{% endblock %}
